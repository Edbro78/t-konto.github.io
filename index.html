<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2.2.3/dist/chartjs-chart-treemap.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Whitney', 'Inter', 'sans-serif']
                    },
                    colors: {
                        'dark-blue': '#002359',
                        'blue': '#002D72',
                        'cyan-40': '#99D9F2',
                        'cyan-20': '#CCECF9',
                        'light-grey': '#F5F3F3',
                        'white': '#FFFFFF',
                        'coal': '#333333',
                        'blue-60': '#627CA5',
                        'blue-15': '#D1D5E0',
                        'coral': '#F66380',
                        'cyan': '#009FDF',
                        'stop-red': '#D9576F',
                        'caution-yellow': '#F2C248',
                        'go-green': '#52CC7B',
                        // New chart colors from provided image
                        'chart-dark-blue': '#002359',
                        'chart-yale-blue': '#12337E',
                        'chart-violet-blue': '#1E4B8B',
                        'chart-crayola-blue': '#447DF7',
                        'chart-jordy-blue': '#9BEFA',
                        'chart-lavender': '#D8E4FD',
                    }
                }
            }
        }
    </script>
    <style>
        @font-face {
            font-family: 'Whitney';
            src: url('https://fonts.cdnfonts.com/s/15451/Whitney-Book.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'Whitney';
            src: url('https://fonts.cdnfonts.com/s/15451/Whitney-Bold.woff') format('woff');
            font-weight: bold;
            font-style: normal;
        }
        @font-face {
            font-family: 'Whitney';
            src: url('https://fonts.cdnfonts.com/s/15451/Whitney-SemiBold.woff') format('woff');
            font-weight: 600;
            font-style: normal;
        }
        body {
            font-family: 'Whitney', 'Inter', sans-serif;
            background-color: #F2F2F2;
        }
        h1, h2, h3, h4, h5 {
            font-family: 'Whitney', 'Inter', sans-serif;
        }
        p {
            font-family: 'Whitney', 'Inter', sans-serif;
        }
        .text-body {
            font-size: 16px;
            font-weight: normal;
            line-height: 1.5;
        }
        .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Styling for the new range inputs with color fill */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
            border-radius: 4px;
        }
        input[type="range"]:hover {
            opacity: 1;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #003359;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
            transition: background .2s;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #003359;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
            transition: background .2s;
        }
        .range-container {
            position: relative;
            display: flex;
            align-items: center;
        }
        .range-container::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            height: 8px;
            background: #48A3A6; /* Default fill color */
            border-radius: 4px 0 0 4px;
            z-index: 1;
        }
        .check-icon {
            color: #52CC7B;
            font-size: 1.5rem;
        }
        .cross-icon {
            color: #D9576F;
            font-size: 1.5rem;
        }
        .remove-btn {
            color: #627CA5; /* A more subtle blue color */
        }
        .remove-btn:hover {
            color: #002D72; /* Darker blue on hover */
        }

        .input-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .label-cell {
            flex-grow: 1;
            padding-right: 1rem;
        }

        .value-cell {
            flex-grow: 1;
            text-align: right;
            font-weight: 600;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="bg-light-grey text-coal antialiased p-8">

    <div class="container mx-auto max-w-7xl">
        
        <!-- Header -->
        <header class="text-center py-8 mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-dark-blue">Økonomisk Dashboard</h1>
            <p class="mt-2 text-lg text-blue-60">En interaktiv oversikt over eiendeler og gjeld.</p>
        </header>

        <!-- Main Dashboard Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Asset & Liability Sliders -->
            <div class="lg:col-span-1 bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-xl md:text-2xl font-bold text-blue mb-6">Tilpass Eiendeler og Gjeld</h2>
                
                <div class="space-y-6">
                    <!-- Eiendeler (Assets) -->
                    <div class="bg-cyan-20 p-4 rounded-xl">
                        <h3 class="font-bold text-lg mb-2 text-dark-blue">Eiendeler</h3>
                        <div id="assets-container" class="space-y-4">
                            <!-- Dynamic assets will be added here by JavaScript -->
                        </div>
                        <button id="add-asset-btn" class="mt-4 w-full bg-blue-60 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue focus:outline-none focus:ring-2 focus:ring-blue-60 focus:ring-offset-2 transition-colors duration-200">
                            Legg til eiendel
                        </button>
                    </div>
                    
                    <!-- Gjeld (Liabilities) -->
                    <div class="bg-cyan-20 p-4 rounded-xl">
                        <h3 class="font-bold text-lg mb-2 text-blue">Gjeld</h3>
                        <div id="liabilities-container" class="space-y-4">
                            <!-- Dynamic liabilities will be added here by JavaScript -->
                        </div>
                        <div class="space-y-4 mt-4">
                            <!-- Fixed input fields for loan term, interest rate, and loan type -->
                            <div>
                                <label for="loan-type" class="block text-sm font-medium text-coal mb-1">Lånetype</label>
                                <select id="loan-type" class="w-full p-2 border border-blue-15 rounded-md text-sm bg-white text-coal">
                                    <option value="annuity">Annuitetslån</option>
                                    <option value="serial">Serielån</option>
                                </select>
                            </div>
                            <div>
                                <label for="loan-term-range" class="block text-sm font-medium text-coal mb-1">Lånetid (år)</label>
                                <div class="range-container">
                                    <input type="range" id="loan-term-range" min="1" max="30" value="25" class="w-full h-2 bg-gray-40 rounded-lg appearance-none cursor-pointer">
                                    <span id="loan-term-value" class="ml-4 text-sm font-semibold w-24 text-right">25 år</span>
                                </div>
                            </div>
                            <div>
                                <label for="interest-rate-range" class="block text-sm font-medium text-coal mb-1">Rentekostnader (%)</label>
                                <div class="range-container">
                                    <input type="range" id="interest-rate-range" min="0.5" max="10" step="0.1" value="4.0" class="w-full h-2 bg-gray-40 rounded-lg appearance-none cursor-pointer">
                                    <span id="interest-rate-value" class="ml-4 text-sm font-semibold w-24 text-right">4.0 %</span>
                                </div>
                            </div>
                        </div>
                        <button id="add-liability-btn" class="mt-4 w-full bg-blue-60 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue focus:outline-none focus:ring-2 focus:ring-blue-60 focus:ring-offset-2 transition-colors duration-200">
                            Legg til gjeld
                        </button>
                    </div>

                    <!-- New Income Inputs -->
                    <div class="bg-cyan-20 p-4 rounded-xl">
                        <h3 class="font-bold text-lg mb-2 text-dark-blue">Inntekt</h3>
                        <div id="income-container" class="space-y-4">
                            <!-- Dynamic income will be added here by JavaScript -->
                        </div>
                         <button id="add-income-btn" class="mt-4 w-full bg-blue-60 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue focus:outline-none focus:ring-2 focus:ring-blue-60 focus:ring-offset-2 transition-colors duration-200">
                            Legg til inntekt
                        </button>
                    </div>
                </div>
            </div>

            <!-- Visualizations and Summary -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- Net Worth Summary -->
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-xl md:text-2xl font-bold text-dark-blue mb-4">Oversikt</h2>
                    <div class="flex flex-col md:flex-row justify-around items-center space-y-4 md:space-y-0 md:space-x-4">
                        <div class="text-center">
                            <h3 class="text-sm md:text-base font-semibold text-coal uppercase">Totale Eiendeler</h3>
                            <p id="total-assets" class="text-3xl md:text-4xl font-bold text-go-green mt-1">25 000 000 kr</p>
                        </div>
                        <div class="text-center">
                            <h3 class="text-sm md:text-base font-semibold text-coal uppercase">Total Gjeld</h3>
                            <p id="total-liabilities" class="text-3xl md:text-4xl font-bold text-stop-red mt-1">11 000 000 kr</p>
                        </div>
                        <div class="text-center">
                            <h3 class="text-sm md:text-base font-semibold text-coal uppercase">Nettoverdi</h3>
                            <p id="net-worth" class="text-3xl md:text-4xl font-bold text-dark-blue mt-1">14 000 000 kr</p>
                        </div>
                    </div>
                </div>

                <!-- T-Account Visualization -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-bold text-blue mb-4 text-center">T-konto: Eiendeler vs. Finansiering</h3>
                    <div class="relative w-full h-[600px] flex">
                        <!-- Assets Column -->
                        <div class="w-1/2 p-4 flex flex-col items-center">
                            <h4 class="text-lg font-bold text-blue-60">Eiendeler</h4>
                            <div id="assets-bar-container" class="w-2/3 h-full bg-white rounded-lg mt-2 relative overflow-hidden flex flex-col-reverse items-center justify-start">
                                <!-- Dynamic asset segments will be added here -->
                            </div>
                        </div>
                        <!-- Separator Line -->
                        <div class="absolute inset-y-0 left-1/2 w-1 bg-coal transform -translate-x-1/2"></div>
                        <!-- Financing Column -->
                        <div class="w-1/2 p-4 flex flex-col items-center">
                            <h4 class="text-lg font-bold text-blue-60">Finansiering</h4>
                            <div id="financing-bar-container" class="w-2/3 h-full bg-white rounded-lg mt-2 relative overflow-hidden flex flex-col-reverse items-center justify-start">
                                <!-- Dynamic financing segments will be added here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Key Ratios Table -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-bold text-blue mb-4">Nøkkeltall og anbefalinger</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left table-auto">
                            <thead class="border-b-2 border-gray-40 text-sm">
                                <tr class="text-dark-blue">
                                    <th class="py-2 px-4 font-semibold">Indikator</th>
                                    <th class="py-2 px-4 font-semibold text-right">Din verdi</th>
                                    <th class="py-2 px-4 font-semibold text-right">Anbefaling</th>
                                </tr>
                            </thead>
                            <tbody id="ratios-table-body" class="text-sm">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data and elements
        let elements = {};
        
        // Chart contexts
        
        // Initial assets, liabilities and income with unique IDs
        let assets = [
            { id: 'asset-1', name: 'Likvider', value: 2000000, max: 10000000, color: '#002359' },
            { id: 'asset-2', name: 'Fast eiendom', value: 15000000, max: 50000000, color: '#12337E' },
            { id: 'asset-3', name: 'Investeringer', value: 8000000, max: 30000000, color: '#1E4B8B' }
        ];
        
        // Add 'Likvider fra finansiering' as a new asset type
        const cashFromFinancing = {
            id: 'asset-fin-cash',
            name: 'Likvider fra finansiering',
            value: 0,
            max: 5000000,
            color: '#447DF7'
        };
        assets.push(cashFromFinancing);


        let liabilities = [
            { id: 'liability-1', name: 'Boliglån', value: 10000000, max: 20000000, color: '#D9576F' },
            { id: 'liability-2', name: 'Annen gjeld', value: 1000000, max: 5000000, color: '#F66380' }
        ];

        let income = [
            { id: 'income-1', name: 'Lønnsinntekt', value: 1500000, max: 5000000, color: '#52CC7B' },
            { id: 'income-2', name: 'Utbytter', value: 0, max: 1000000, color: '#83C48E' },
            { id: 'income-3', name: 'Andre inntekter', value: 0, max: 1000000, color: '#A5D6A7' }
        ];

        // Function to format currency
        const formatCurrency = (value) => {
            return new Intl.NumberFormat('nb-NO', { style: 'currency', currency: 'NOK', maximumFractionDigits: 0 }).format(value);
        };
        const formatPercentage = (value) => {
            return (value * 100).toFixed(1) + '%';
        };

        // Function to calculate loan payment based on type
        const calculateLoanPayment = (principal, rate, years, loanType) => {
            if (principal === 0 || years === 0) {
                return { monthly: 0, annual: 0, interest: 0, principal: 0 };
            }
            
            const annualRate = rate;
            const monthlyRate = annualRate / 12;
            const numberOfPayments = years * 12;

            if (loanType === 'annuity') {
                if (annualRate === 0) {
                    const annualPrincipal = principal / years;
                    return { monthly: annualPrincipal / 12, annual: annualPrincipal, interest: 0, principal: annualPrincipal };
                }
                const monthlyPayment = principal * (monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments)) / (Math.pow(1 + monthlyRate, numberOfPayments) - 1);
                const annualPayment = monthlyPayment * 12;
                
                // First year's interest and principal payment
                const firstYearInterest = principal * annualRate;
                const firstYearPrincipal = annualPayment - firstYearInterest;

                return { monthly: monthlyPayment, annual: annualPayment, interest: firstYearInterest, principal: firstYearPrincipal };
            } else if (loanType === 'serial') {
                const annualPrincipal = principal / years;
                const firstYearInterest = principal * annualRate;
                const firstYearTotal = annualPrincipal + firstYearInterest;
                
                return { monthly: firstYearTotal / 12, annual: firstYearTotal, interest: firstYearInterest, principal: annualPrincipal };
            }

            return { monthly: 0, annual: 0, interest: 0, principal: 0 };
        };

        // Function to update the T-Account chart
        const updateTAccountChart = (totalAssets, totalLiabilities, netWorth) => {
            const assetsContainer = document.getElementById('assets-bar-container');
            const financingContainer = document.getElementById('financing-bar-container');

            // Clear previous elements
            assetsContainer.innerHTML = '';
            financingContainer.innerHTML = '';

            const total = totalAssets;
            const gapHeight = 16; // Height of the gap in pixels for better spacing
            const minHeightPx = 40; // Minimum height for each bar

            // Render assets
            const assetValues = assets.map(asset => asset.value);
            const totalAssetValues = assetValues.reduce((sum, value) => sum + value, 0);

            assets.forEach((asset, index) => {
                if (asset.value > 0) {
                    const heightPercentage = totalAssetValues > 0 ? (asset.value / totalAssetValues) * 100 : 0;
                    const assetDiv = document.createElement('div');
                    assetDiv.className = `w-full relative flex items-center justify-center text-center transition-all duration-300 rounded-md`;
                    assetDiv.style.backgroundColor = asset.color;
                    assetDiv.style.height = `max(${heightPercentage}%, ${minHeightPx}px)`; // Use max to ensure minimum height
                    assetDiv.style.marginBottom = `${gapHeight}px`; // Add space between categories
                    assetDiv.innerHTML = `<span class="text-white text-xs font-bold p-1">${asset.name}<br>${formatCurrency(asset.value)}</span>`;
                    assetsContainer.appendChild(assetDiv);
                }
            });
            
            // Render financing (liabilities and equity)
            const financingValues = [totalLiabilities, netWorth];
            const totalFinancingValues = financingValues.reduce((sum, value) => sum + value, 0);

            if (totalLiabilities > 0) {
                const liabilitiesDiv = document.createElement('div');
                const liabilityHeightPercentage = totalFinancingValues > 0 ? (totalLiabilities / totalFinancingValues) * 100 : 0;
                liabilitiesDiv.className = `w-full relative flex items-center justify-center text-center transition-all duration-300 rounded-md`;
                liabilitiesDiv.style.height = `max(${liabilityHeightPercentage}%, ${minHeightPx}px)`;
                liabilitiesDiv.style.backgroundColor = '#D9576F';
                liabilitiesDiv.style.marginBottom = `${gapHeight}px`;
                liabilitiesDiv.innerHTML = `<span class="text-white text-xs font-bold p-1">Gjeld<br>${formatCurrency(totalLiabilities)}</span>`;
                financingContainer.appendChild(liabilitiesDiv);
            }

            if (netWorth > 0) {
                const equityDiv = document.createElement('div');
                const equityHeightPercentage = totalFinancingValues > 0 ? (netWorth / totalFinancingValues) * 100 : 0;
                equityDiv.className = `w-full relative flex items-center justify-center text-center transition-all duration-300 rounded-md`;
                equityDiv.style.height = `max(${equityHeightPercentage}%, ${minHeightPx}px)`;
                equityDiv.style.backgroundColor = '#52CC7B';
                equityDiv.innerHTML = `<span class="text-white text-xs font-bold p-1">Egenkapital<br>${formatCurrency(netWorth)}</span>`;
                financingContainer.appendChild(equityDiv);
            }
        };

        // Function to update the background fill of the range input
        function updateRangeFill(input, value, max, fillColor) {
            const percentage = (value / max) * 100;
            input.style.setProperty('background', `linear-gradient(to right, ${fillColor} 0%, ${fillColor} ${percentage}%, #e0e0e0 ${percentage}%, #e0e0e0 100%)`);
        }

        // Main update function
        const updateDashboard = () => {
            const mortgageValue = liabilities.find(l => l.name === 'Boliglån')?.value || 0;
            const annualInterestRate = parseFloat(document.getElementById('interest-rate-range').value) / 100;
            const loanTerm = parseInt(document.getElementById('loan-term-range').value);
            const loanType = document.getElementById('loan-type').value;
            const annenGjeldValue = liabilities.find(l => l.name.toLowerCase() === 'annen gjeld')?.value || 0;

            // Update display values and range fill for fixed elements
            document.getElementById('loan-term-value').textContent = `${loanTerm} år`;
            updateRangeFill(document.getElementById('loan-term-range'), loanTerm, document.getElementById('loan-term-range').max, '#009FDF');
            document.getElementById('interest-rate-value').textContent = `${parseFloat(document.getElementById('interest-rate-range').value).toFixed(1)} %`;
            updateRangeFill(document.getElementById('interest-rate-range'), parseFloat(document.getElementById('interest-rate-range').value), document.getElementById('interest-rate-range').max, '#D9576F');
            
            // Update "Likvider fra finansiering" based on "Annen gjeld"
            const cashFromFinancingAsset = assets.find(a => a.name.toLowerCase() === 'likvider fra finansiering');
            if (cashFromFinancingAsset) {
                cashFromFinancingAsset.value = annenGjeldValue;
                const cashDisplay = document.getElementById(cashFromFinancingAsset.id);
                if (cashDisplay) {
                    cashDisplay.textContent = formatCurrency(annenGjeldValue);
                }
            }


            // Calculate totals from dynamic assets
            let totalAssets = 0;
            const assetLabels = [];
            const assetData = [];
            assets.forEach(asset => {
                totalAssets += asset.value;
                assetLabels.push(asset.name);
                assetData.push(asset.value);
            });

            // Update the dynamic asset sliders
            const assetInputs = document.getElementById('assets-container').querySelectorAll('input[type="range"]');
            const assetDisplays = document.getElementById('assets-container').querySelectorAll('.asset-value-display');
            assetInputs.forEach((input, index) => {
                updateRangeFill(input, input.value, input.max, assets[index].color);
                assetDisplays[index].textContent = formatCurrency(parseInt(input.value));
            });

            // Calculate totals from dynamic liabilities
            let totalLiabilities = 0;
            liabilities.forEach(liability => {
                totalLiabilities += liability.value;
            });
            
            // Update the dynamic liability sliders
            const liabilityInputs = document.getElementById('liabilities-container').querySelectorAll('input[type="range"]');
            const liabilityDisplays = document.getElementById('liabilities-container').querySelectorAll('.liability-value-display');
            liabilityInputs.forEach((input, index) => {
                const liability = liabilities[index]; // Corrected
                updateRangeFill(input, input.value, input.max, liability.color);
                liabilityDisplays[index].textContent = formatCurrency(parseInt(input.value));
            });

            // Calculate totals from dynamic income
            let totalAnnualIncome = 0;
            income.forEach(inc => {
                totalAnnualIncome += inc.value;
            });

            const incomeInputs = document.getElementById('income-container').querySelectorAll('input[type="range"]');
            const incomeDisplays = document.getElementById('income-container').querySelectorAll('.income-value-display');
            incomeInputs.forEach((input, index) => {
                updateRangeFill(input, input.value, input.max, income[index].color);
                incomeDisplays[index].textContent = formatCurrency(parseInt(input.value));
            });


            const netWorth = totalAssets - totalLiabilities;
            const equity = totalAssets - totalLiabilities;
            const annualPayment = calculateLoanPayment(mortgageValue, annualInterestRate, loanTerm, loanType);

            // Update summary
            document.getElementById('total-assets').textContent = formatCurrency(totalAssets);
            document.getElementById('total-liabilities').textContent = formatCurrency(totalLiabilities);
            document.getElementById('net-worth').textContent = formatCurrency(netWorth);
            if (netWorth < 0) {
                document.getElementById('net-worth').classList.remove('text-go-green', 'text-dark-blue');
                document.getElementById('net-worth').classList.add('text-stop-red');
            } else {
                document.getElementById('net-worth').classList.remove('text-stop-red', 'text-dark-blue');
                document.getElementById('net-worth').classList.add('text-go-green');
            }

            // Update T-account
            updateTAccountChart(totalAssets, totalLiabilities, netWorth);

            // Update tables
            
            document.getElementById('ratios-table-body').innerHTML = '';
            const totalAnnualPayment = annualPayment.annual;
            const loanToIncomeRatio = totalAnnualIncome > 0 ? totalLiabilities / totalAnnualIncome : 0;
            const debtToEquityRatio = equity > 0 ? totalLiabilities / equity : 0;
            const annualPaymentToIncomeRatio = totalAnnualIncome > 0 ? totalAnnualPayment / totalAnnualIncome : 0;

            const incomeToDebtRec = 0.2; // Minst 20%
            const statusIncomeToDebt = totalLiabilities > 0 && totalAnnualIncome / totalLiabilities >= incomeToDebtRec;
            const checkIncomeToDebt = statusIncomeToDebt ? '<i class="fa-solid fa-check check-icon"></i>' : '<i class="fa-solid fa-xmark cross-icon"></i>';
            
            const paymentToIncomeRec = 0.3; // Maks 30%
            const statusPaymentToIncome = totalAnnualIncome > 0 && annualPaymentToIncomeRatio <= paymentToIncomeRec;
            const checkPaymentToIncome = statusPaymentToIncome ? '<i class="fa-solid fa-check check-icon"></i>' : '<i class="fa-solid fa-xmark cross-icon"></i>';

            const loanToIncomeRec = 5; // Maks 5
            const statusLoanToIncome = totalAnnualIncome > 0 && loanToIncomeRatio <= loanToIncomeRec;
            const checkLoanToIncome = statusLoanToIncome ? '<i class="fa-solid fa-check check-icon"></i>' : '<i class="fa-solid fa-xmark cross-icon"></i>';
            
            const debtToEquityRec = 2.5; // Maks 2.5
            const statusDebtToEquity = equity > 0 && debtToEquityRatio <= debtToEquityRec;
            const checkDebtToEquity = statusDebtToEquity ? '<i class="fa-solid fa-check check-icon"></i>' : '<i class="fa-solid fa-xmark cross-icon"></i>';

            
            const ratios = [
                { label: 'Sum inntekter', value: totalAnnualIncome, format: formatCurrency, recommended: '-', status: null },
                { label: 'Renter og avdrag per år', value: totalAnnualPayment, format: formatCurrency, recommended: '-', status: null },
                { label: 'Sum Inntekter / Gjeld', value: totalLiabilities > 0 ? totalAnnualIncome / totalLiabilities : 0, format: (val) => `${val.toFixed(2)}x`, recommended: `> 20%`, status: checkIncomeToDebt },
                { label: 'Renter og avdrag / Sum inntekter', value: annualPaymentToIncomeRatio, format: formatPercentage, recommended: `< 30%`, status: checkPaymentToIncome },
                { label: 'Gjeld / Sum inntekter', value: loanToIncomeRatio, format: (val) => `${val.toFixed(2)}x`, recommended: `< 5x`, status: checkLoanToIncome },
                { label: 'Gjeldsgrad (gjeld / egenkapital)', value: debtToEquityRatio, format: (val) => `${val.toFixed(2)}x`, recommended: `< 2.5x`, status: checkDebtToEquity },
            ];
            
            ratios.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200';
                const formattedValue = item.format(item.value);
                row.innerHTML = `
                    <td class="py-2 px-4">${item.label}</td>
                    <td class="py-2 px-4 font-semibold text-right">${formattedValue}</td>
                    <td class="py-2 px-4 font-semibold text-right">${item.recommended} ${item.status ? item.status : ''}</td>
                `;
                document.getElementById('ratios-table-body').appendChild(row);
            });
        };

        // Function to create a new asset input
        const createAssetInput = (asset) => {
            const inputGroup = document.createElement('div');
            inputGroup.className = 'flex items-center space-x-2 bg-white rounded-md p-2 w-full';
            
            let innerHtml = ``;

            if (asset.name.toLowerCase() === 'likvider fra finansiering') {
                innerHtml = `
                    <div class="flex items-center space-x-2 bg-white rounded-md p-2 w-full">
                        <p class="w-2/5 text-sm font-semibold">${asset.name}</p>
                        <div class="flex items-center space-x-2 w-3/5">
                            <span id="${asset.id}" class="text-sm font-semibold w-full text-right">${formatCurrency(asset.value)}</span>
                        </div>
                        <button class="remove-asset-btn text-blue-60 hover:text-dark-blue transition-colors duration-200 p-2">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                `;
            } else {
                innerHtml = `
                    <div class="flex items-center space-x-2 bg-white rounded-md p-2 w-full">
                        <input type="text" value="${asset.name}" class="asset-name-input w-2/5 p-2 border border-blue-15 rounded-md text-sm bg-white text-coal" placeholder="Navn på eiendel">
                        <div class="range-container w-3/5 flex items-center space-x-2">
                            <input type="range" id="${asset.id}" min="0" max="${asset.max}" value="${asset.value}" class="asset-value-input w-full h-2 bg-gray-40 rounded-lg appearance-none cursor-pointer">
                            <span class="asset-value-display ml-4 text-sm font-semibold w-24 text-right">${formatCurrency(asset.value)}</span>
                        </div>
                        <button class="remove-asset-btn text-blue-60 hover:text-dark-blue transition-colors duration-200 p-2">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                `;
            }
            
            inputGroup.innerHTML = innerHtml;

            // Add event listeners for dynamic assets
            if (asset.name.toLowerCase() !== 'likvider fra finansiering') {
                const valueInput = inputGroup.querySelector('.asset-value-input');
                const nameInput = inputGroup.querySelector('.asset-name-input');
                const removeBtn = inputGroup.querySelector('.remove-asset-btn');

                const updateAsset = () => {
                    const index = assets.findIndex(a => a.id === asset.id);
                    if (index > -1) {
                        assets[index].value = parseInt(valueInput.value);
                        assets[index].name = nameInput.value;
                        updateDashboard();
                    }
                };

                valueInput.addEventListener('input', updateAsset);
                nameInput.addEventListener('input', updateAsset);
                removeBtn.addEventListener('click', () => {
                    assets = assets.filter(a => a.id !== asset.id);
                    inputGroup.remove();
                    updateDashboard();
                });
            }
            return inputGroup;
        };
        
        // Function to create a new liability input
        const createLiabilityInput = (liability) => {
            const inputGroup = document.createElement('div');
            inputGroup.className = 'space-y-2 flex items-center space-x-2';
            inputGroup.innerHTML = `
                <input type="text" value="${liability.name}" class="liability-name-input w-2/5 p-2 border border-blue-15 rounded-md text-sm bg-white text-coal" placeholder="Navn på gjeld">
                <div class="range-container w-3/5 flex items-center space-x-2">
                    <input type="range" id="${liability.id}" min="0" max="${liability.max}" value="${liability.value}" class="liability-value-input w-full h-2 bg-gray-40 rounded-lg appearance-none cursor-pointer">
                    <span class="liability-value-display ml-4 text-sm font-semibold w-24 text-right">${formatCurrency(liability.value)}</span>
                </div>
                <button class="remove-liability-btn text-blue-60 hover:text-dark-blue transition-colors duration-200 p-2">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            `;
            const valueInput = inputGroup.querySelector('.liability-value-input');
            const nameInput = inputGroup.querySelector('.liability-name-input');
            const valueDisplay = inputGroup.querySelector('.liability-value-display');
            const removeBtn = inputGroup.querySelector('.remove-liability-btn');

            const updateLiability = () => {
                const index = liabilities.findIndex(l => l.id === liability.id);
                if (index > -1) {
                    const newValue = parseInt(valueInput.value);
                    liabilities[index].value = newValue;
                    liabilities[index].name = nameInput.value;
                    updateDashboard();
                }
            };
            
            valueInput.addEventListener('input', updateLiability);
            nameInput.addEventListener('input', updateLiability);
            removeBtn.addEventListener('click', () => {
                liabilities = liabilities.filter(l => l.id !== liability.id);
                inputGroup.remove();
                updateDashboard();
            });
            return inputGroup;
        };
        
        // Function to create a new income input
        const createIncomeInput = (incomeItem) => {
            const inputGroup = document.createElement('div');
            inputGroup.className = 'space-y-2 flex items-center space-x-2';
            inputGroup.innerHTML = `
                <input type="text" value="${incomeItem.name}" class="income-name-input w-2/5 p-2 border border-blue-15 rounded-md text-sm bg-white text-coal" placeholder="Navn på inntekt">
                <div class="range-container w-3/5 flex items-center space-x-2">
                    <input type="range" id="${incomeItem.id}" min="0" max="${incomeItem.max}" value="${incomeItem.value}" class="income-value-input w-full h-2 bg-gray-40 rounded-lg appearance-none cursor-pointer">
                    <span class="income-value-display ml-4 text-sm font-semibold w-24 text-right">${formatCurrency(incomeItem.value)}</span>
                </div>
                <button class="remove-income-btn text-blue-60 hover:text-dark-blue transition-colors duration-200 p-2">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            `;
            const valueInput = inputGroup.querySelector('.income-value-input');
            const nameInput = inputGroup.querySelector('.income-name-input');
            const valueDisplay = inputGroup.querySelector('.income-value-display');
            const removeBtn = inputGroup.querySelector('.remove-income-btn');
            
            const updateIncome = () => {
                const index = income.findIndex(i => i.id === incomeItem.id);
                if (index > -1) {
                    income[index].value = parseInt(valueInput.value);
                    income[index].name = nameInput.value;
                    valueDisplay.textContent = formatCurrency(parseInt(valueInput.value));
                    updateDashboard();
                }
            };

            valueInput.addEventListener('input', updateIncome);
            nameInput.addEventListener('input', updateIncome);
            removeBtn.addEventListener('click', () => {
                income = income.filter(i => i.id !== incomeItem.id);
                inputGroup.remove();
                updateDashboard();
            });

            return inputGroup;
        };
        
        // Function to render all assets, liabilities and income
        const renderAssets = () => {
            elements.assetsContainer.innerHTML = '';
            assets.forEach(asset => {
                if (asset.name.toLowerCase() === 'likvider fra finansiering') {
                    // This is a special category and should not be a dynamic slider
                    const inputGroup = document.createElement('div');
                    inputGroup.className = 'flex items-center space-x-2 bg-white rounded-md p-2';
                    inputGroup.innerHTML = `
                        <p class="w-2/5 text-sm font-semibold">${asset.name}</p>
                        <div class="flex items-center space-x-2 w-3/5">
                            <span id="${asset.id}" class="text-sm font-semibold w-full text-right">${formatCurrency(asset.value)}</span>
                        </div>
                        <button class="remove-asset-btn text-blue-60 hover:text-dark-blue transition-colors duration-200 p-2">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    `;
                    elements.assetsContainer.appendChild(inputGroup);

                    const removeBtn = inputGroup.querySelector('.remove-asset-btn');
                    removeBtn.addEventListener('click', () => {
                        assets = assets.filter(a => a.id !== asset.id);
                        inputGroup.remove();
                        updateDashboard();
                    });

                } else {
                    elements.assetsContainer.appendChild(createAssetInput(asset));
                }
            });
        };
        
        const renderLiabilities = () => {
            elements.liabilitiesContainer.innerHTML = '';
            liabilities.forEach(liability => {
                elements.liabilitiesContainer.appendChild(createLiabilityInput(liability));
            });
        };

        const renderIncome = () => {
            elements.incomeContainer.innerHTML = '';
            income.forEach(incomeItem => {
                elements.incomeContainer.appendChild(createIncomeInput(incomeItem));
            });
        };


        // Initial render
        window.onload = () => {
            elements = {
                assetsContainer: document.getElementById('assets-container'),
                addAssetBtn: document.getElementById('add-asset-btn'),
                liabilitiesContainer: document.getElementById('liabilities-container'),
                addLiabilityBtn: document.getElementById('add-liability-btn'),
                incomeContainer: document.getElementById('income-container'),
                addIncomeBtn: document.getElementById('add-income-btn'),
                loanTerm: document.getElementById('loan-term-range'),
                interestRate: document.getElementById('interest-rate-range'),
                loanType: document.getElementById('loan-type'),
                loanTermValue: document.getElementById('loan-term-value'),
                interestRateValue: document.getElementById('interest-rate-value'),
                totalAssets: document.getElementById('total-assets'),
                totalLiabilities: document.getElementById('total-liabilities'),
                netWorth: document.getElementById('net-worth'),
                ratiosTableBody: document.getElementById('ratios-table-body')
            };
            
            // Add 'Likvider fra finansiering' as a new asset type
            const cashFromFinancing = {
                id: 'asset-fin-cash',
                name: 'Likvider fra finansiering',
                value: 0,
                max: 5000000,
                color: '#447DF7'
            };
            
            // Ensure cashFromFinancing is in assets if it's not a dynamic asset
            if (!assets.find(a => a.id === cashFromFinancing.id)) {
                 assets.push(cashFromFinancing);
            }
            
            renderAssets();
            renderLiabilities();
            renderIncome();
            
            // Add listeners after elements and charts are initialized
            elements.addAssetBtn.addEventListener('click', () => {
                const newId = `asset-${Date.now()}`;
                const newAsset = { id: newId, name: 'Ny eiendel', value: 100000, max: 1000000, color: '#CCECF9' }; // Change here to make it light blue
                assets.push(newAsset);
                elements.assetsContainer.appendChild(createAssetInput(newAsset));
                updateDashboard();
            });

            elements.addLiabilityBtn.addEventListener('click', () => {
                const newId = `liability-${Date.now()}`;
                const newLiability = { id: newId, name: 'Ny gjeld', value: 100000, max: 1000000, color: '#F66380' };
                liabilities.push(newLiability);
                elements.liabilitiesContainer.appendChild(createLiabilityInput(newLiability));
                updateDashboard();
            });

            elements.addIncomeBtn.addEventListener('click', () => {
                const newId = `income-${Date.now()}`;
                const newIncome = { id: newId, name: 'Ny inntekt', value: 0, max: 1000000, color: '#A5D6A7' };
                income.push(newIncome);
                elements.incomeContainer.appendChild(createIncomeInput(newIncome));
                updateDashboard();
            });

            elements.loanTerm.addEventListener('input', updateDashboard);
            elements.interestRate.addEventListener('input', updateDashboard);
            elements.loanType.addEventListener('change', updateDashboard);
            
            // Add event listener for dynamic liability input to update cash from financing
            document.getElementById('liabilities-container').addEventListener('input', (event) => {
                const target = event.target;
                if (target.classList.contains('liability-value-input') || target.classList.contains('liability-name-input')) {
                    const annenGjeldInput = liabilities.find(l => l.name.toLowerCase() === 'annen gjeld');
                    const cashFromFinancingAsset = assets.find(a => a.name.toLowerCase() === 'likvider fra finansiering');
                    if (annenGjeldInput && cashFromFinancingAsset) {
                        const annenGjeldElement = document.getElementById(annenGjeldInput.id);
                        if (annenGjeldElement) {
                             const annenGjeldValue = parseInt(annenGjeldElement.value);
                            cashFromFinancingAsset.value = annenGjeldValue;
                            updateDashboard();
                        }
                    }
                }
            });

            updateDashboard();

        };
    </script>

</body>
</html>
